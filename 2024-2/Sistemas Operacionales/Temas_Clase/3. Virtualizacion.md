# 3. Virtualizacion

En cietas situaciones, una empresa tiene una multicomputadora pero en realidad no la quiere. Un ejemplo comun es cuando una empresa tiene un servidor de correo electronico, un servidor Web, un Servidro FTP, algunos servidores de comercio electronico, y otros servidores mas. Todos esto servidores e ejecutan en distintas computadoreas del mismo bastidor de equipos , y todos estan conectados por una red de alta velocidad; en toras palabras, es una multicomputadora. EN algunos casos, todos estos servidores se ejecutan en maquinas separadas debido a que una sola maquina no puede manejar la carga, pero en muchos otros casos la razon principal para no ejecutar todos estos servicioes como procesos en la misma maquina es la confiabilidad: La administracion simplemente no confia en que el sistema operativo se ejecute las 24 horas del dia, los 365 dias del año sin fallas. Al colocar cada servicio enuna computadora separada, si falla uno de los servidres por lo menos los demas no se veran afectados. Aunque de esta forma se logra la tolerancia a fallas, esta solucion es costosa y dificil de administrar debido a que hat muchas maquinas involucradas.

¿Que se debe hacer?  Se ha propuesto como solucionla tecnologia de maquinas virtuales, que a menudo se conoce como **Virtualizacion** y tiene mas de 40 años. Esta tecnologia permite que una sola computadora contega varias maquinas virtuales, cada una de las cuales puede llegar a ejecutar un sistema operativo distinto. La ventaja de este metodo es que una falla en  una maquina virtual no ocasiona que las demas fallen de manera automatica. En un sistema virtualizado, se puede ejecutar distintos servidores en diferentes maquinas virtuales, con lo cual se mantiene el modelo parcial de fallas que tiene una computadora, pero a un costo mucho menor y con una administracion mas sencilla.

Claro que consolidar los servidores de esta forma es como poner todos los huevos en una canasta. Si falla el servidor que ejecuta todas las maquinas virtuales, el resultado es aun mas catastrofico que cuando falla un solo servidor dedicado. Sim embargo, la razon por la que la virtualizacion puede funcionar es que la mayotia de fallas en los servidores no se deben a un hardware defectuoso, sino al software presuntioso, poco confiable y lleno de errores, en especial los sistemas operativos. COn la tecnologia de maquinas virtuales., el unico software que se ejecuta en modo del kernel es el hipervisor, el cual tiene 100 veces menos lineas de codigo que un sistema operativo completo, y por ende tiene 100 veces menos errores.

La ejecucion de software en las maquinas virtuales tiene otras ventajas ademas de un solido aislamiento. Una de ellas es que al tener menos maquinas fisicas hat un ahorro en hardware y electricidad, y se ocupa menos espacio en la oficina. Para una compañia como Amazon, Yahoom Microsoft o Google, que puede tener cientos de miles de servidores que realizan una enorme variedad de tareas distintas, la reduccion de las demandas fisicas en sus centros de datos representa un enorme ahorro en los costos. Por lo general, en las empresas grandes los departamentos individuales o grupos puensan en una idea interesante y despues van y compran un servidro para implementarla. SI la idea tiene exito y se requieren cientos  o miles de servidores, se expande el chentro de datos corporativo. A menodp es dificil mover el software a las distintas maquinas existentes, debido a que cada aplicacion necesita con frecunecia una version distinta del sistema operativo, sus propias bibliotecas, archivos de configuracion y demas. Con las maquinas virtuales, cada aplicacion puede tener su propio entorno.

Otra ventaja de las maquinas virtuales es que es mucho mas facil usar putos de comprobacion y migrar datos entre una maquina virtual y otro (Por ejemplo, Para balancear la carga entre varios servidores) que migrar procesos que se ejecutan en un sistema operativo normal. EN este ultimo caos, se mantiene una cantidad considerable de informacion critica de estado sobre cada proceso en las tablas del sistema operativo, inclutendo la informacion relacionada con la apetura de archivos, las alarmans, los manejadores de señales y demas. Al migrar una maquina virtual, todo lo que hay que mover es la imagen de memoria, ta que todas las tablas del sistema operativo se mueven tambien.

Otro uso para las maquinas virtualizacion es para ejecutar aplicaciones heredadas en los sistemas operativos (O en versiondes de los sistemas operativos) que ya no tiene soporte o que no funcionan en el hardware actual. Estas aplicaciones heredades se pueden ejecutar al mismo tiempo y en el mismo hardware que las aplicaciones actuales. De hecho, la habilidad de ejecutar al mismo tiempo aplicaciones que utilizan distintos sistemas operativos es un gran argumento a favor de las maquinas virtuales.

El desarrolo de software es otro uso aun mas importante de las maquinas virtuales. Un programador que quiera asegurarse que su software funciona en Windows 98 , Windows 2000 , Windows XP , Windows Vista, Varias versiones de Linux, FREBSD y Mac OS X ya no tiene que conseguir una docena de computadoreas e instalr distintos sistemas ioerativos en todas ellas. Lo unico que tiene que hacer es crear una docena de maquinas virtuales en una sola computadora e instalar distintos sistemas operativos encada maquina virtual. Desde luego que el programador podria haver particionado el disco duro para instalar un sistema operativo distinto en cada particion, pero este metodo es mas dificultoso. En primero lugar, las PCs estandar solo soportan cuatro particioens primarias de disco, sin importar que tan grande sea. En segundo lugar, aunque se podria instalar un progrma de multiarranque en el bloque de arranque, seria necesario reiniciar la computadora para trabajar en otro sistema operativo. Con las maquinas virtuales todos los sistemas operativos se puede ejecutar al mismo tiempo,ya que en erealidad solo son procesos glorificados.

## Requerimientos para la Virtualizacion

Hay dos metodos para la virtualizacion el primero es el denominado hipervisor de tipo 1 (O monitor de maquina virtual). En realida es el sistema operativo, ya que es el unico programa que se ejecuta en modo kernel. Su trabajo es soportar varia copias del hardware actual, conocidas como maquinas virtuales, de una manera similar a los procesos que soporta un sistema operativo normal. Por el contrario, un hipervisor del tipo 2 es algo completamente distino. Es solo un program de usuario que se ejecuta En un sistema operativo (Windows o Linux) e interpreta el conjunto de isntrucciones de la maquina, el cual tambien crea una maquina virtual. El sistema operativo que se ejecuta encima del hipervisor en ambos casos se denomina sistema operativo invitado. EN el caso de un hipervisor del tipo 2, el sistema operativo se ejecuta en el hardware se denomina sistema operativo anfrition.

Es importante tenr en cuenta que en ambos casos las maquinas virtuales deben actuar justo de igual forma que el hardware real. Especificamente, debe ser posible iniciarlas como maquinas reales e instalar cualquier sistema operativo en ellas, justo como lo que se puede hacer con el hardware real. La tarea del hipervisor es brindar esta ilusion con eficiencia (Sin ser un interprete compelto). La raxon de que jaya dos tipos de hipervisores se debe a ciertos defectos en la arquitectura del Inter 386 que se acarrearon servilmente a las nuevas CPUs durante 20 años, para mantener la compatibilidad inversa. En sintesis, cada CPU con modo kernel y modo de usuario tiene un conjunto de instrucciones que solo se puede ejecutar en modo de kernel, como las intrucciones que realizan operaciones de E/S, las que modifican opciones de la MMU, etc.

Popek y GOldberg desarrollaron un trabajo clasico sobre virtualizacion, en el cual a esta instrucciones les llamaron **Instrucciones sencibles**. Tambien hay un conjunto de instrucciones que porducen una trapa (interrupcion) si se ejecutan en modo usuario. A estas instrucciones le llamaron **Instrucciones Privilegiadas**. En su articulo declararon por pirmera vez que una maquina se puede virtualizar solo si las instrucciones sencibles son un subconjunto de las instrucciones privilegiadas. 

En realidad la situacion es un poco peor de lo que se muestra. Ademas de los problemas con las instrucciones que no se puede atrapar en modo de usuario, hay instrucciones que puede leer el estado sensible en modo de usuario sin producir una interrupcion. Por ejemplim en el Pentium un programa puede determinar si se esta ejecutando en modo de usuario o en modo de kernel y¿con solo leer su selector del segmento de codigo. Un sistema operativo que hiciera esto y descubrieraque se encuentra en modo de usuaio podria tomar una decision incorrecta con base en esta informacion.

Este problema se resolvio cuando Intel y AMD introdujeron la virtualizacion en sus CPUs, empezando en el 2005. En las CPUs de Intel Core 2 se conoce cmom VT (Tecnologia de Virtualizacion) en las CPUs de AMD Pacific se conoce como SVM (Maquina Virtual Segura). A continuacion utilizaremos el termino VT en un sentido Generico. Ambas tecnologias se inspirarion en el trabajo de la IBM VM/370, pero tiene unas cuantas diferencias. La idea basica es crear contenedores en los que se pueden ejecutar maquinas virtuales. Cuando se inicia un sistema operativo invitado en un contenedor, se sigue ejecutando ahi hasta que se produce una excepcion y se atrapa en el hipervisor por ejemplo, mediante la ejecucion de una instruccion de E/S. El conjunto de operaciones que se atrapan se controla mediante un mapa de bits de hardware por el hipervisor. Con estas extensiones, es posible utilizar el clasivo metodo de atrapar y emular de una maquina virtual.

